<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Live Captured</title> 
<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="http://cdn.peerjs.com/0.3/peer.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="http://maps.googleapis.com/maps/api/js"></script>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
<!-- Optional theme -->
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
</head>

<body>
<script>
//fonctions
var mon_id;
var mon_nom;
var statut_Alice;
var calling;
statut_Alice={i_d: "",nom: "",diffuseur: false,spectateur: false,localisation: null, self_video_URL:null};
var Statut;
var liste_diffuseurs=[];
var self_video = document.getElementById("self_video_player");
//var localStream;
var remote_video = document.getElementById("remote_video_player");
var id_dest;
var liste_boutons=[];

navigator.getUserMedia = ( navigator.getUserMedia ||
                       navigator.webkitGetUserMedia ||
                       navigator.mozGetUserMedia ||
                       navigator.msGetUserMedia);

var socket = io.connect('http://localhost:8080');
//PeerServer en cloud
var peer ;
function connexionPeerServeur(){
	//clef pour utiliser le PeerServeur en cloud...limite a 50 users, mais en opensource
	//peer= new Peer({key: 'i006gh58pu95dn29'});
	//serveur STUN google, pour passer les NAT
	peer= new Peer({key: 'i006gh58pu95dn29',config: {'iceServers': [{ url: 'stun:stun.l.google.com:19302' } ]}});
	peer.on('open',function(){
		mon_nom= document.getElementById('name_id').value
		console.log('votre nom est: ' +mon_nom);
		document.getElementById("header").innerHTML='<label for="disconnect_button">Bonjour ' + mon_nom+'</label>';
		document.getElementById("header").style.visibility ="visible";
		document.getElementById("connect_div").style.visibility ="hidden";
		document.getElementById("nav").style.visibility ="visible";
		document.getElementById("disconnect").style.visibility ="visible";
		mon_id= this.id;
		statut_Alice={i_d: mon_id,nom: mon_nom,diffuseur: false,spectateur: false,localisation: null,self_video_URL:null};
		Statut={statut_alice: statut_Alice};
		ajoutStatut();
		afficher_liste();
	});

	//recevoir des appels
 	peer.on('call', function(call){
      // Answer the call automatically (instead of prompting user) for demo purposes
      call.answer(window.localStream);
      //step3(call);
    });
};

socket.on('envoieDB', function(liste){
	indice_dernier_elt = liste.length -1;
	if (indice_dernier_elt<0){indice_dernier_elt=0;}
	///
	//gerer la liste
	document.getElementById("diff_list").innerHTML='';
	document.getElementById("diff_list").innerHTML='liste des diffuseurs<br/>';
	document.getElementById("diff_list").innerHTML+='<div class="btn-group-vertical">';
	//document.getElementById("diff_list").innerHTML+='<ul class="nav nav-pills nav-stacked">';
	for (var k=0;k<liste.length;k++){
		liste_diffuseurs=[];
		liste_diffuseurs[k]=liste[k];
		var id_destination= String(liste_diffuseurs[k].i_d);
		console.log('ceci est l id destination: ' +id_destination);
		
		var button = document.createElement("button") ;
		//button.innerHTML+='<li>';
        button.type = "button" ;
        button.innerHTML+=liste_diffuseurs[k].nom;
        button.setAttribute ("class","btn btn-primary");
        button.value = liste_diffuseurs[k].nom ;
        button.name = liste_diffuseurs[k].nom ;
        button.setAttribute("onClick","return CallPeer('"+id_destination+"')") ;
        //button.innerHTML+='</li>';
        document.getElementById("diff_list").appendChild(button);
        
        //document.getElementById("diff_list").innerHTML+='</div>';
        
	}
	//document.getElementById("diff_list").innerHTML+='</ul>';
	document.getElementById("diff_list").innerHTML+='</div>';
	////
	//console.log('on recoit une liste');

})

function ajoutStatut(){
	//socket.emit('ajout_statut',Statut);
	socket.emit('ajout_statut',statut_Alice);
	console.log('envoie nouveau Statut');
}
function MAJStatut(){
	socket.emit('maj_statut',statut_Alice);
	console.log('envoie MAJ Statut');
}

function CallPeer(id_dest){
	//console.log('CallPeer id: '+id_dest);
	//self_video = document.getElementById("self_video_player");
	//console.log(self_video);
	//Pb avec localStream
	var calling= peer.call(id_dest,window.localStream);
	calling.on('stream', function(stream){
		//remote_video.src=URL.createObjectURL(stream);
        $('#remote_video_player').prop('src', URL.createObjectURL(stream));
    });

    //revenir a la page live
    afficher_videos();
}

function filmer(){
	if (navigator.getUserMedia) {
	   navigator.getUserMedia (
	      // constraints
	      {
	         video: true,
	         audio: true
	      },
	      // successCallback
	      function(localMediaStream) {
	      	 window.localStream=localMediaStream;
	      	 self_video = document.getElementById("self_video_player");
	         self_video.src = window.URL.createObjectURL(localMediaStream);
	         statut_Alice.self_video_URL=self_video.src;
	         console.log('self_video.src : '+self_video.src);
	         // Do something with the video here, e.g. video.play()
	         self_video.play();
	         document.getElementById("bouton_filmer").disabled =true;
	         document.getElementById("bouton_arret_film").disabled =false;
	         statut_Alice.diffuseur=true;
	         Statut={statut_alice: statut_Alice};
	         MAJStatut();
	      },
	      // errorCallback
	      function(err) {
	         console.log("The following error occured: " + err);
	      }
	   );
	} else {console.log("getUserMedia not supported");}
}
function stop_filmer(){
	//impossible de desactiver getusermedia -ie la webcam- par l'api (donc sans appuyer MANUELLEMENT)
	//risque(?) de probleme d'utilisation en fond sur un smartphone sans que le user puisse le voir
	document.getElementById("bouton_filmer").disabled =false;
	document.getElementById("bouton_arret_film").disabled =true;
	statut_Alice.diffuseur=false;
	statut_Alice.self_video_URL=null;
	Statut={statut_alice: statut_Alice};
	MAJStatut();
}

/////deconnexion
function deco(){
	console.log('Deco');
	alert('vous vous etes deconnecte');
	//peer.disconnect();
	socket.disconnect();
	document.getElementById("header").style.visibility ="hidden";
	document.getElementById("connect_div").style.visibility ="hidden";
	document.getElementById("nav").style.visibility ="hidden";
	document.getElementById("diff_list").style.visibility ="hidden";
	document.getElementById("self_video").style.visibility ="hidden";
	document.getElementById("regarder_div").style.visibility ="hidden";
	document.getElementById("localisation_div").style.visibility ="hidden";
	document.getElementById("disconnect").style.visibility ="hidden";
	return;
}

function afficher_videos(){
	document.getElementById("diff_list").style.visibility ="hidden";
	document.getElementById("self_video").style.visibility ="visible";
	document.getElementById("regarder_div").style.visibility ="visible";
	document.getElementById("localisation_div").style.visibility ="hidden";
}
function afficher_liste(){
	document.getElementById("diff_list").style.visibility ="visible";
	document.getElementById("self_video").style.visibility ="hidden";
	document.getElementById("regarder_div").style.visibility ="hidden";
	document.getElementById("localisation_div").style.visibility ="hidden";
}
function afficher_map(){
	document.getElementById("diff_list").style.visibility ="hidden";
	document.getElementById("self_video").style.visibility ="hidden";
	document.getElementById("regarder_div").style.visibility ="hidden";
	document.getElementById("localisation_div").style.visibility ="visible";
}

//window.onbeforeunload=deco();
</script>
<!-- Interface graphique -->
<div id="connect_div" class="container-fluid" style="visibility : visible;">
	<div class="jumbotron">
	<label for="name_id">Identifiez-vous!</label>
	<input type="text" class="form-control" placeholder="Entrez votre nom" name="nom" id="name_id" required/><br/>
	<input type="button" class="btn btn-primary"  value="Connexion" id="demande_connexion" onclick="connexionPeerServeur()"/>
	<script>
	$('#name_id').focus();
	</script>
	</div>
</div>
<nav class="navbar navbar-default" style="visibility:hidden;">
<div class="container-fluid">
	<div class="navbar-header">
		<div id="header" style="visibility:hidden;">
		</div>
		<div id="bouton_filmer" style="visibility:hidden;">
			<input type="button" class="btn btn-danger" value="Filmer" id="bouton_filmer" onclick="filmer()"/>
		</div>
		<div id="disconnect" style="visibility:hidden;">
			<input type="button" class="btn btn-warning" value="Deconnexion" id="disconnect_button" onclick="deco()"/>
		</div>
	</div>	
	<div id="nav_bouton" >
		<div class="btn-group-sg">
			<input type="button" class="btn btn-info" value="Live" id="live_button" onclick="afficher_videos()"/>
			<input type="button" class="btn btn-info" value="Captors List" id="List_button" onclick="afficher_liste()"/>
			<input type="button" class="btn btn-info" value="Captors Map" id="List_button" onclick="afficher_map()"/>
		</div>
	</div>
			
</div>
</nav>


<div id="diff_list" class="container-fluid" style="visibility:hidden;">
</div>
<div id="regarder_div" style="visibility:hidden;">
	<input type="button" value="Regarder" id="bouton_regarder" onclick="filmer()"/>
	<input type="button" value="Stop" id="bouton_arret" onclick="stop_filmer()"/>
	<video id="remote_video_player" autoplay>
	</video>
</div>
<div id="self_video" style="visibility:hidden;">
	<input type="button" value="Stop" id="bouton_arret_film" onclick="stop_filmer()"/>
	<video id="self_video_player" autoplay>
	</video>
</div>

<div id="localisation_div" style="visibility:hidden;">
	<input type="button" value="Geolocalisation" id="location_button" onclick="getLocation()"/>
	<input type="button" value="Qui est dans le coin?" id="others_location_button" onclick="askOthersPositions()" style="visibility:hidden;"/>
	<div id="infos_div"></div>
	<div id="googleMap" style="width:500px;height:380px;"></div>
</div>

</body> 
</html>